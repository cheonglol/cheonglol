---
import fs from "node:fs";
import path from "node:path";

// Read selfies at build time
const selfiesDir = path.join(process.cwd(), "public/images/selfies");
let images: string[] = [];
let startImage = "";
try {
  if (fs.existsSync(selfiesDir)) {
    const allFiles = fs
      .readdirSync(selfiesDir)
      .filter((f) => /\.(jpg|jpeg|png|gif|webp)$/i.test(f))
      .sort();

    // start.png is the default static image, not part of the cycle pool
    startImage = allFiles.includes("start.png")
      ? `/cheonglol/images/selfies/start.png`
      : "";

    images = allFiles
      .filter((f) => f !== "start.png")
      .map((f) => `/cheonglol/images/selfies/${f}`);
  }
} catch {
  /* no selfies folder */
}

const initialSrc = startImage || images[0] || "";
---

{
  initialSrc && (
    <div class="selfie-carousel">
      <img
        id="selfie-img"
        src={initialSrc}
        alt="selfie"
        class="selfie"
        data-images={JSON.stringify(images)}
        data-start={startImage}
      />
      <p id="selfie-caption" class="selfie-caption">
        &lt;boring mode&gt;
      </p>
    </div>
  )
}

<script>
  const img = document.getElementById("selfie-img") as HTMLImageElement | null;
  const caption = document.getElementById(
    "selfie-caption",
  ) as HTMLParagraphElement | null;
  if (img) {
    const images: string[] = JSON.parse(img.dataset.images || "[]");
    const startSrc = img.dataset.start || "";
    let cycling = false;
    let intervalId: ReturnType<typeof setInterval> | null = null;
    let currentIndex = 0;
    let isTransitioning = false;

    function cycleNext() {
      if (isTransitioning) return;
      isTransitioning = true;

      img.classList.add("fading-out");

      setTimeout(() => {
        currentIndex = (currentIndex + 1) % images.length;
        img.src = images[currentIndex];
        img.classList.remove("fading-out");
        img.classList.add("fading-in");

        setTimeout(() => {
          img.classList.remove("fading-in");
          isTransitioning = false;
        }, 500);
      }, 500);
    }

    function startCycling() {
      cycling = true;
      if (caption) {
        caption.textContent = "\u2728";
        caption.classList.add("aura-mode");
      }
      // Immediately show first cycle image
      currentIndex = 0;
      isTransitioning = true;
      img.classList.add("fading-out");
      setTimeout(() => {
        img.src = images[currentIndex];
        img.classList.remove("fading-out");
        img.classList.add("fading-in");
        setTimeout(() => {
          img.classList.remove("fading-in");
          isTransitioning = false;
        }, 500);
      }, 500);

      intervalId = setInterval(() => {
        cycleNext();
      }, 4000);
    }

    function stopCycling() {
      cycling = false;
      if (caption) {
        caption.textContent = "<boring mode>";
        caption.classList.remove("aura-mode");
      }
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }
      // Reset to start image
      isTransitioning = true;
      img.classList.add("fading-out");
      setTimeout(() => {
        img.src = startSrc;
        currentIndex = 0;
        img.classList.remove("fading-out");
        img.classList.add("fading-in");
        setTimeout(() => {
          img.classList.remove("fading-in");
          isTransitioning = false;
        }, 500);
      }, 500);
    }

    img.addEventListener("click", () => {
      if (images.length === 0) return;
      if (cycling) {
        stopCycling();
      } else {
        startCycling();
      }
    });
    img.style.cursor = "pointer";
  }
</script>

<style>
  .selfie-carousel {
    display: block;
  }

  .selfie-caption {
    text-align: center;
    font-size: 0.75rem;
    font-family: "JetBrains Mono", monospace;
    color: #888;
    margin-top: 6px;
    margin-bottom: 0;
  }

  .selfie-caption.aura-mode {
    color: #8b5cf6;
  }

  .selfie {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 12px;
    transition:
      filter 0.5s ease-in-out,
      box-shadow 0.5s ease-in-out,
      border-color 0.5s ease-in-out;
    filter: brightness(1) saturate(1);
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
    border: 2px solid transparent;
  }

  @media (hover: hover) {
    .selfie:hover:not(.fading-out) {
      border-color: #8b5cf6;
    }
  }

  .selfie.fading-out {
    filter: brightness(5) saturate(0);
    box-shadow: 0 0 40px 20px rgba(255, 255, 255, 0.7);
    border-color: #ffffff;
  }

  .selfie.fading-in {
    filter: brightness(1) saturate(1);
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
    border-color: transparent;
  }
</style>
